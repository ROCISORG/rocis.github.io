<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ROCIS ‚Äì Outdoor Data Explorer</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://unpkg.com/papaparse@5/papaparse.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: "Times New Roman", Times, serif;
      background: linear-gradient(135deg, #f0f8ff 0%, #e6f3ff 50%, #dbeafe 100%);
      min-height: 100vh;
      color: #2d3748;
      line-height: 1.6;
      font-size: 20px;
    }
    
    .nav {
      background: white;
      border-bottom: 2px solid #e2e8f0;
      position: sticky;
      top: 0;
      z-index: 1000;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .nav-content {
      max-width: 1600px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 2rem;
    }
    
    .brand {
      font-weight: 800;
      font-size: 2.2rem;
      color: #2b6cb0;
      text-decoration: none;
    }
    
    .nav-links {
      display: flex;
      gap: 2rem;
    }
    
    .nav-links a {
      color: #4a5568;
      text-decoration: none;
      font-weight: 600;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      transition: all 0.2s ease;
      font-size: 1.2rem;
    }
    
    .nav-links a:hover {
      background: #e6f3ff;
      color: #2b6cb0;
    }
    
    .container {
      max-width: 1800px;
      margin: 0 auto;
      padding: 1rem 1rem 2rem 1rem;
    }
    
    .hero {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(248, 250, 252, 0.95));
      backdrop-filter: blur(10px);
      padding: 2rem 3rem 1.5rem 3rem;
      border-radius: 12px;
      margin-bottom: 1.5rem;
      text-align: center;
      border: 1px solid rgba(59, 130, 246, 0.1);
      box-shadow: 0 8px 32px rgba(59, 130, 246, 0.1);
      position: relative;
    }
    
    .hero::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, #1a365d, #2c5aa0, #4a90a4);
      border-radius: 12px 12px 0 0;
    }
    
    .hero h1 {
      margin: 0 0 1rem;
      font-size: 4rem;
      font-weight: 400;
      background: linear-gradient(135deg, #1a365d, #2c5aa0);
      background-clip: text;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      letter-spacing: 0.01em;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .hero p {
      margin: 0;
      font-size: 1.8rem;
      color: #4a5568;
      font-weight: 400;
      font-style: italic;
    }
    
    .view-toggle {
      display: flex;
      justify-content: center;
      gap: 1.5rem;
      margin-bottom: 2rem;
    }
    
    .view-btn {
      padding: 1rem 2.5rem;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(248, 250, 252, 0.8));
      backdrop-filter: blur(5px);
      border: 1px solid rgba(0, 0, 0, 0.08);
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 1.3rem;
      color: #4a5568;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      font-family: "Times New Roman", Times, serif;
      position: relative;
      overflow: hidden;
    }
    
    .view-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }
    
    .view-btn:hover::before {
      left: 100%;
    }
    
    .view-btn.active {
      background: linear-gradient(135deg, #1a365d, #2c5aa0);
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(26, 54, 93, 0.3);
      border-color: #1a365d;
    }
    
    .view-btn:hover:not(.active) {
      background: linear-gradient(135deg, rgba(26, 54, 93, 0.1), rgba(44, 90, 160, 0.1));
      color: #1a365d;
      transform: translateY(-1px);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }
    
    .cohort-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
      margin-bottom: 2rem;
    }
    
    .cohort-grid.single {
      grid-template-columns: 1fr;
      max-width: 800px;
      margin: 0 auto 2rem auto;
    }
    
    .cohort-panel {
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid rgba(59, 130, 246, 0.2);
      border-radius: 12px;
      padding: 2rem;
      box-shadow: 0 4px 16px rgba(59, 130, 246, 0.1);
      backdrop-filter: blur(5px);
    }
    
    .cohort-panel h3 {
      margin: 0 0 1.5rem;
      font-size: 1.8rem;
      font-weight: 700;
      color: #2d3748;
      text-align: center;
    }
    
    .cohort-panel.large h3 {
      color: #2b6cb0;
    }
    
    .cohort-panel.total h3 {
      color: #059669;
    }
    
    .cohort-dropdown {
      width: 100%;
      padding: 1rem;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 1.2rem;
      font-weight: 500;
      background: white;
      cursor: pointer;
      transition: all 0.2s ease;
      color: #2d3748;
      outline: none;
      margin-bottom: 1rem;
    }
    
    .cohort-dropdown:focus {
      border-color: #2b6cb0;
      box-shadow: 0 0 0 3px rgba(43, 108, 176, 0.1);
    }
    
    .region-filter {
      margin-top: 1rem;
    }
    
    .region-filter label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-weight: 500;
      color: #4a5568;
      cursor: pointer;
    }
    
    .main-controls {
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid rgba(59, 130, 246, 0.2);
      border-radius: 12px;
      padding: 2rem;
      margin: 2rem 0;
      display: none;
      box-shadow: 0 4px 16px rgba(59, 130, 246, 0.1);
      backdrop-filter: blur(5px);
    }
    
    .main-controls.show {
      display: block;
    }
    
    .controls-grid {
      display: grid;
      grid-template-columns: 300px 1fr;
      gap: 3rem;
      align-items: start;
    }
    
    .control-panel {
      background: #f8f9fa;
      padding: 1.5rem;
      border-radius: 8px;
      border: 1px solid #e2e8f0;
    }
    
    .control-panel h4 {
      margin: 0 0 1rem;
      font-size: 1.3rem;
      font-weight: 700;
      color: #2d3748;
    }
    
    .scale-toggle, .zoom-controls, .accessibility-toggle {
      display: flex;
      gap: 0.5rem;
      margin: 1rem 0;
    }
    
    .scale-btn, .zoom-btn, .accessibility-btn {
      flex: 1;
      padding: 0.8rem;
      border: 2px solid #e2e8f0;
      background: white;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 1.2rem;
      transition: all 0.2s ease;
      color: #4a5568;
    }
    
    .scale-btn.active, .zoom-btn.active {
      background: #2b6cb0;
      color: white;
      border-color: #2b6cb0;
    }
    
    .accessibility-btn.active {
      background: #059669;
      color: white;
      border-color: #059669;
    }
    
    .scale-btn:hover:not(.active), .zoom-btn:hover:not(.active) {
      background: #e6f3ff;
      color: #2b6cb0;
      border-color: #2b6cb0;
    }
    
    .accessibility-btn:hover:not(.active) {
      background: #dcfce7;
      color: #059669;
      border-color: #059669;
    }
    
    .help-btn {
      background: #6366f1;
      color: white;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin-left: 0.5rem;
      transition: all 0.2s ease;
      vertical-align: middle;
    }
    
    .help-btn:hover {
      background: #4f46e5;
      transform: scale(1.1);
    }
    
    .button {
      background: #2b6cb0;
      color: white;
      padding: 1rem 1.5rem;
      border: none;
      border-radius: 6px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      margin: 0.3rem 0;
      transition: all 0.2s ease;
      width: 100%;
    }
    
    .button:hover {
      background: #2c5aa0;
    }
    
    .button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    .button.secondary {
      background: #38a169;
    }
    
    .series-selection {
      background: #f8f9fa;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 1.5rem;
    }
    
    .series-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    
    .series-header h4 {
      margin: 0;
      font-size: 1.3rem;
      font-weight: 700;
      color: #2d3748;
    }
    
    .series-search {
      width: 100%;
      padding: 0.6rem;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      font-size: 0.9rem;
      margin-bottom: 1rem;
      outline: none;
    }
    
    .series-search:focus {
      border-color: #2b6cb0;
      box-shadow: 0 0 0 2px rgba(43, 108, 176, 0.1);
    }
    
    .series-controls {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    
    .series-control-btn {
      padding: 0.5rem 0.8rem;
      background: white;
      color: #2b6cb0;
      border: 1px solid #2b6cb0;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8rem;
      font-weight: 600;
      transition: all 0.2s ease;
    }
    
    .series-control-btn:hover {
      background: #2b6cb0;
      color: white;
    }
    
    .series-list {
      max-height: none;
      overflow-y: visible;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      padding: 0.8rem;
      background: white;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.5rem;
      column-gap: 1rem;
    }
    
    .series-item {
      display: flex;
      align-items: center;
      padding: 0.5rem;
      margin: 0;
      border-radius: 4px;
      transition: background 0.2s ease;
      cursor: pointer;
    }
    
    .series-item:hover {
      background: #f7fafc;
    }
    
    .series-item input[type="checkbox"] {
      margin-right: 0.8rem;
      transform: scale(1.1);
    }
    
    .color-indicator {
      width: 14px;
      height: 14px;
      border-radius: 3px;
      margin-right: 0.6rem;
      border: 1px solid #e2e8f0;
    }
    
    .series-label {
      flex: 1;
      font-weight: 500;
      color: #2d3748;
      font-size: 0.9rem;
    }
    
    .visibility-btn {
      padding: 0.2rem 0.5rem;
      background: #e2e8f0;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      font-size: 0.7rem;
      color: #4a5568;
      transition: all 0.2s ease;
    }
    
    .visibility-btn:hover {
      background: #cbd5e0;
    }
    
    .visibility-btn.hidden {
      background: #feb2b2;
      color: #c53030;
    }
    
    #chart {
      width: 100%;
      height: 900px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      margin: 2rem 0;
      background: white;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .chart-info {
      background: #f0f8ff;
      border: 1px solid #bee3f8;
      border-radius: 8px;
      padding: 1.2rem;
      margin: 1rem 0;
      text-align: center;
    }
    
    .chart-info h4 {
      margin: 0 0 0.3rem;
      color: #2b6cb0;
      font-size: 1.2rem;
      font-weight: 700;
    }
    
    .chart-info p {
      color: #4a5568;
      font-weight: 500;
      margin: 0;
      font-size: 0.95rem;
    }
    
    .pennsylvania-filter {
      background: #f0fff4;
      border: 1px solid #9ae6b4;
      border-radius: 6px;
      padding: 1rem;
      margin: 1rem 0;
    }
    
    .pennsylvania-filter label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-weight: 600;
      color: #2f855a;
      cursor: pointer;
    }
    
    /* Cohort Grid Styles */
    .cohort-grid-container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .cohort-grid-row {
      display: grid;
      grid-template-columns: repeat(10, 1fr);
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .cohort-button {
      background: white;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      padding: 1.25rem 0.75rem;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
      font-family: "Times New Roman", Times, serif;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .cohort-button:hover {
      border-color: #2b6cb0;
      background: #e6f3ff;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(43, 108, 176, 0.2);
    }

    .cohort-button.selected {
      background: linear-gradient(135deg, #1a365d, #2c5aa0);
      color: white;
      border-color: #1a365d;
      box-shadow: 0 4px 12px rgba(26, 54, 93, 0.3);
    }

    .cohort-number {
      font-size: 1.25rem;
      font-weight: 700;
      color: #2d3748;
      margin-bottom: 0.5rem;
    }

    .cohort-button.selected .cohort-number {
      color: white;
    }

    .cohort-date {
      font-size: 0.875rem;
      font-weight: 500;
      color: #718096;
    }

    .cohort-button.selected .cohort-date {
      color: rgba(255, 255, 255, 0.9);
    }
    
    @media (max-width: 1200px) {
      .controls-grid {
        grid-template-columns: 1fr;
        gap: 2rem;
      }
      
      .cohort-grid {
        grid-template-columns: 1fr;
      }

      .cohort-grid-row {
        grid-template-columns: repeat(5, 1fr);
      }

      .series-list {
        grid-template-columns: repeat(2, 1fr);
      }
      
      #compareCharts > div {
        grid-template-columns: 1fr !important;
      }
    }
    
    @media (max-width: 768px) {
      .container {
        padding: 1rem;
      }
      
      .hero {
        padding: 1.5rem;
      }
      
      .hero h1 {
        font-size: 2rem;
      }
      
      .view-toggle {
        flex-direction: column;
        align-items: center;
      }
      
      .view-btn {
        width: 100%;
        max-width: 300px;
      }

      .cohort-grid-row {
        grid-template-columns: repeat(3, 1fr);
      }
      
      .cohort-button {
        padding: 1rem 0.5rem;
      }
      
      .cohort-number {
        font-size: 1.125rem;
      }
      
      .cohort-date {
        font-size: 0.75rem;
      }

      .series-list {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 480px) {
      .cohort-grid-row {
        grid-template-columns: repeat(2, 1fr);
        gap: 0.75rem;
      }
      
      .cohort-button {
        padding: 0.875rem 0.5rem;
      }
      
      .cohort-number {
        font-size: 1rem;
      }
      
      .cohort-date {
        font-size: 0.7rem;
      }
    }
  </style>
</head>
<body>
  <nav class="nav">
    <div class="nav-content">
      <a class="brand" href="./">ROCIS</a>
      <div class="nav-links">
        <a href="./about.html">About</a>
      </div>
    </div>
  </nav>

  <div class="container">
    <div class="hero">
      <h1>Outdoor Data Explorer</h1>
      
      <!-- Data Disclaimer - Compact Version -->
      <div style="background: linear-gradient(135deg, #fff3cd, #fff8e1); border: 1px solid #ffc107; border-radius: 8px; padding: 1rem 1.5rem; margin-top: 1.5rem; box-shadow: 0 2px 8px rgba(255, 193, 7, 0.15);">
        <h3 style="margin: 0 0 0.5rem 0; color: #856404; font-size: 1.1rem; font-weight: 700;">Data Notice</h3>
        <p style="margin: 0; color: #856404; font-size: 0.95rem; line-height: 1.5; font-weight: 500;">
          This visualization displays <strong>raw, unprocessed data</strong> that has not been quality-checked or validated. 
          The data has not been corrected for environmental factors such as <strong>humidity or relative humidity</strong>, 
          and may contain inaccuracies due to <strong>equipment malfunctions, sensor errors, or human error</strong>.
        </p>
      </div>

      <!-- Troubleshooting Notice -->
      <div style="background: linear-gradient(135deg, #dbeafe, #eff6ff); border: 1px solid #3b82f6; border-radius: 8px; padding: 1rem 1.5rem; margin-top: 1rem; box-shadow: 0 2px 8px rgba(59, 130, 246, 0.15);">
        <h3 style="margin: 0 0 0.5rem 0; color: #1e40af; font-size: 1.1rem; font-weight: 700;">
          ‚ÑπÔ∏è Troubleshooting Tips
        </h3>
        <p style="margin: 0; color: #1e40af; font-size: 0.95rem; line-height: 1.5; font-weight: 500;">
          If you do not see updates to the cohort selection, notice any glitches, or if the graphs are not displaying correctly, 
          please <strong>refresh the page</strong> by clicking the URL at the top of your browser or pressing <strong>Ctrl+R</strong> (Windows) 
          or <strong>Cmd+R</strong> (Mac).
        </p>
      </div>
    </div>

   <div class="view-toggle">
      <button class="view-btn" onclick="switchView('compare')">Compare Large vs Total (Same Cohort)</button>
      <button class="view-btn active" onclick="switchView('single')">Single Dataset</button>
    </div>

    <!-- Single View -->
    <div id="single-view" class="view-content">
      <div class="cohort-panel" style="max-width: 1600px; margin: 0 auto;">
        <h3>Select Dataset Type & Cohort</h3>
        
        <!-- Dataset Type Selection -->
        <div style="margin-bottom: 2rem;">
          <label style="display: block; margin-bottom: 0.75rem; font-weight: 600; color: #2d3748; font-size: 1.1rem;">
            Dataset Type:
          </label>
          <div style="display: flex; gap: 1rem; justify-content: center;">
            <button class="view-btn" id="singleLargeBtn" onclick="selectSingleType('large')">Large Particles</button>
            <button class="view-btn" id="singleSmallBtn" onclick="selectSingleType('small')">Total Particles</button>
          </div>
        </div>
        
        <!-- Cohort Grid -->
        <div id="singleCohortGridContainer" style="display: none;">
          <h4 style="text-align: center; color: #2d3748; margin-bottom: 1rem;">Select Cohort:</h4>
          <div class="cohort-grid-container">
            <!-- Row 1: Cohorts 1-10 -->
            <div class="cohort-grid-row" id="singleCohortRow1"></div>
            
            <!-- Row 2: Cohorts 11-20 -->
            <div class="cohort-grid-row" id="singleCohortRow2"></div>
            
            <!-- Row 3: Cohorts 21-30 -->
            <div class="cohort-grid-row" id="singleCohortRow3"></div>
            
            <!-- Row 4: Cohorts 32-41 -->
            <div class="cohort-grid-row" id="singleCohortRow4"></div>
            
            <!-- Row 5: Cohorts 42-51 -->
            <div class="cohort-grid-row" id="singleCohortRow5"></div>
            
            <!-- Row 6: Cohorts 52-61 -->
            <div class="cohort-grid-row" id="singleCohortRow6"></div>
            
            <!-- Row 7: Cohorts 62-66 -->
            <div class="cohort-grid-row" id="singleCohortRow7"></div>
          </div>
        </div>
        
        <div class="pennsylvania-filter">
          <label>
            <input type="checkbox" id="singlePaFilter"> Pennsylvania participants only
          </label>
        </div>
      </div>
    </div>

    <!-- Compare View -->
    <div id="compare-view" class="view-content" style="display: none;">
      <div class="cohort-panel" style="max-width: 1600px; margin: 0 auto;">
        <h3>Select Cohort for Large vs Total Comparison</h3>
        
        <div class="cohort-grid-container">
          <!-- Row 1: Cohorts 1-10 -->
          <div class="cohort-grid-row" id="compareCohortRow1"></div>
          
          <!-- Row 2: Cohorts 11-20 -->
          <div class="cohort-grid-row" id="compareCohortRow2"></div>
          
          <!-- Row 3: Cohorts 21-30 -->
          <div class="cohort-grid-row" id="compareCohortRow3"></div>
          
          <!-- Row 4: Cohorts 32-41 (skipping 31) -->
          <div class="cohort-grid-row" id="compareCohortRow4"></div>
          
          <!-- Row 5: Cohorts 42-51 -->
          <div class="cohort-grid-row" id="compareCohortRow5"></div>
          
          <!-- Row 6: Cohorts 52-61 -->
          <div class="cohort-grid-row" id="compareCohortRow6"></div>
          
          <!-- Row 7: Cohorts 62-66 -->
          <div class="cohort-grid-row" id="compareCohortRow7"></div>
        </div>
        
        <div class="pennsylvania-filter">
          <label>
            <input type="checkbox" id="comparePaFilter"> Pennsylvania participants only
          </label>
        </div>
      </div>
    </div>

    <div id="mainControls" class="main-controls">
      <div class="chart-info">
        <h4 id="selectedCohortTitle">No cohort selected</h4>
        <p id="selectedCohortDesc">Select datasets above to begin visualization</p>
      </div>
      
      <div class="controls-grid">
        <div class="control-panel">
          <h4>Controls</h4>
          <button class="button" id="loadBtn" onclick="loadData()">Load Dataset</button>
          <button class="button reset" id="resetBtn" onclick="resetAndRefresh()">üîÑ Reset / Change Cohort</button>

          <button class="button secondary" onclick="downloadData()">Download CSV</button>
          
          <h4>Accessibility</h4>
          <div class="accessibility-toggle">
            <button class="accessibility-btn" onclick="toggleColorblind()">Enable Colorblind Mode</button>
          </div>
          
          <h4>
            Scale Type
            <button class="help-btn" onclick="showScaleHelp()" title="Learn more">?</button>
          </h4>
          <div class="scale-toggle">
            <button class="scale-btn" onclick="setScale('log')">Log</button>
            <button class="scale-btn active" onclick="setScale('linear')">Linear</button>
          </div>
      
          <div style="margin-top: 1rem; padding: 1rem; background: white; border-radius: 6px; border: 1px solid #e2e8f0;">
            <strong style="color: #2d3748; font-size: 0.9rem;">
              Data Sampling:
              <button class="help-btn" onclick="showSamplingHelp()" title="Learn more">?</button>
            </strong><br>
            <label style="margin: 0.4rem 0; display: block; font-weight: 500; color: #4a5568; font-size: 0.85rem;">
              <input type="radio" name="sampling" value="1" checked style="margin-right: 0.5rem;"> All points
            </label>
            <label style="margin: 0.4rem 0; display: block; font-weight: 500; color: #4a5568; font-size: 0.85rem;">
              <input type="radio" name="sampling" value="5" style="margin-right: 0.5rem;"> Every 5th
            </label>
            <label style="margin: 0.4rem 0; display: block; font-weight: 500; color: #4a5568; font-size: 0.85rem;">
              <input type="radio" name="sampling" value="10" style="margin-right: 0.5rem;"> Every 10th
            </label>
          </div>
        </div>
        
        <div class="series-selection">
          <div class="series-header">
            <h4>Data Series</h4>
            <span id="seriesCount" style="font-size: 0.85rem; font-weight: 500; color: #718096;">(0 available)</span>
          </div>
          
          <input type="text" class="series-search" id="seriesSearch" placeholder="Search series..." onkeyup="filterSeries()">
          
          <div class="series-controls">
            <button class="series-control-btn" onclick="selectAllSeries()">Select All</button>
            <button class="series-control-btn" onclick="clearAllSeries()">Clear All</button>
          </div>
          
          <div id="seriesList" class="series-list">
            <p style="color: #718096; text-align: center; margin: 2rem 0; font-weight: 500;">Load a dataset to see available data series</p>
          </div>
        </div>
      </div>
    </div>

    <div id="chart"></div>
    <div id="compareCharts" style="display: none;">
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin: 2rem 0;">
        <div>
          <h3 style="text-align: center; color: #2b6cb0; margin-bottom: 1rem; font-size: 1.4rem;">Large Particles</h3>
          <div id="chartLarge" style="width: 100%; height: 750px; border: 1px solid #e2e8f0; border-radius: 8px; background: white; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);"></div>
        </div>
        <div>
          <h3 style="text-align: center; color: #059669; margin-bottom: 1rem; font-size: 1.4rem;">Total Particles</h3>
          <div id="chartTotal" style="width: 100%; height: 750px; border: 1px solid #e2e8f0; border-radius: 8px; background: white; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ============================================
    // GLOBAL STATE VARIABLES
    // ============================================
    let currentView = 'single';
    let selectedCohorts = { single: null, large: null, total: null };
    let currentData = { single: null, large: null, total: null };
    let allSeries = [];
    let currentScale = 'linear';
    let isColorblindMode = false;
    let hiddenSeries = new Set();
    let selectedSeries = new Set();
    let selectedSingleType = null;
    let pennsylvaniaData = {};
    
    const defaultColors = [
      "#2563EB", "#DC2626", "#059669", "#EA580C", "#7C3AED",
      "#0891B2", "#DB2777", "#2563EB", "#65A30D", "#C026D3",
      "#0D9488", "#E11D48", "#4F46E5", "#CA8A04", "#16A34A"
    ];
    
    const colorblindColors = [
      "#1f77b4", "#ff7f0e", "#2ca02c", "#d62728", "#9467bd",
      "#8c564b", "#e377c2", "#17becf", "#bcbd22", "#aec7e8",
      "#ffbb78", "#98df8a", "#ff9896", "#c5b0d5", "#c49c94"
    ];
    
    const NON_PA_PATTERNS = [
      '_ME', '_CA', '_OR', '_MN', '_FL', '_TX', '_NY', '_WA', '_IL',
      'CASJ', 'ORCB', 'MEBA', 'MNMP'
    ];

    // ============================================
    // COHORT DATES
    // ============================================
    const cohortDates = {
      1: "Sep 24, 2015", 2: "Oct 24, 2015", 3: "Nov 24, 2015", 4: "Jan 8, 2016",
      5: "Feb 6, 2016", 6: "Mar 3, 2016", 7: "May 2, 2016", 8: "May 26, 2016",
      9: "Jul 30, 2016", 10: "Aug 6, 2016", 11: "Sep 9, 2016", 12: "Oct 6, 2016",
      13: "Nov 11, 2016", 14: "Dec 10, 2016", 15: "Jan 12, 2017", 16: "Feb 16, 2017",
      17: "Mar 20, 2017", 18: "Apr 27, 2017", 19: "Jun 1, 2017", 20: "Jul 11, 2017",
      21: "Aug 5, 2017", 22: "Sep 2, 2017", 23: "Oct 2, 2017", 24: "Nov 12, 2017",
      25: "Dec 11, 2017", 26: "Jan 13, 2018", 27: "Feb 10, 2018", 28: "Mar 23, 2018",
      29: "Apr 23, 2018", 30: "Jun 2, 2018", 32: "Aug 17, 2018", 33: "Sep 16, 2018",
      34: "Nov 1, 2018", 35: "Dec 15, 2018", 36: "Jan 12, 2019", 37: "Feb 20, 2019",
      38: "Mar 22, 2019", 39: "Jun 15, 2019", 40: "Jul 25, 2019", 41: "Sep 13, 2019",
      42: "Jan 22, 2020", 43: "Apr 16, 2020", 44: "Sep 6, 2020", 45: "Nov 5, 2020",
      46: "Jan 20, 2021", 47: "Apr 13, 2021", 48: "Jul 10, 2021", 49: "Oct 8, 2021",
      50: "Dec 7, 2021", 51: "Mar 2, 2022", 52: "Sep 16, 2022", 53: "Dec 1, 2022",
      54: "Feb 22, 2023", 55: "Apr 30, 2023", 56: "Aug 28, 2023", 57: "Nov 10, 2023",
      58: "Jan 31, 2024", 59: "Apr 19, 2024", 60: "Aug 18, 2024", 61: "Nov 8, 2024",
      62: "Feb 2, 2025", 63: "Apr 12, 2025", 64: "Jun 19, 2025", 65: "Sep 10, 2025",
      66: "Nov 16, 2025"
    };

    // ============================================
    // COHORT GRID GENERATION
    // ============================================
    function generateSingleCohortGrid() {
      const rows = [
        { id: 'singleCohortRow1', cohorts: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10] },
        { id: 'singleCohortRow2', cohorts: [11, 12, 13, 14, 15, 16, 17, 18, 19, 20] },
        { id: 'singleCohortRow3', cohorts: [21, 22, 23, 24, 25, 26, 27, 28, 29, 30] },
        { id: 'singleCohortRow4', cohorts: [32, 33, 34, 35, 36, 37, 38, 39, 40, 41] },
        { id: 'singleCohortRow5', cohorts: [42, 43, 44, 45, 46, 47, 48, 49, 50, 51] },
        { id: 'singleCohortRow6', cohorts: [52, 53, 54, 55, 56, 57, 58, 59, 60, 61] },
        { id: 'singleCohortRow7', cohorts: [62, 63, 64, 65, 66] }
      ];
      
      rows.forEach(row => {
        const container = document.getElementById(row.id);
        if (!container) return;
        
        container.innerHTML = '';
        
        row.cohorts.forEach(i => {
          const button = document.createElement('div');
          button.className = 'cohort-button';
          button.setAttribute('data-cohort', i);
          button.setAttribute('data-view', 'single');
          button.onclick = () => selectSingleCohortFromGrid(i);
          
          button.innerHTML = `
            <div class="cohort-number">Cohort ${i}</div>
            <div class="cohort-date">${cohortDates[i] || 'TBD'}</div>
          `;
          
          container.appendChild(button);
        });
      });
    }

    function generateCompareCohortGrid() {
      const rows = [
        { id: 'compareCohortRow1', cohorts: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10] },
        { id: 'compareCohortRow2', cohorts: [11, 12, 13, 14, 15, 16, 17, 18, 19, 20] },
        { id: 'compareCohortRow3', cohorts: [21, 22, 23, 24, 25, 26, 27, 28, 29, 30] },
        { id: 'compareCohortRow4', cohorts: [32, 33, 34, 35, 36, 37, 38, 39, 40, 41] },
        { id: 'compareCohortRow5', cohorts: [42, 43, 44, 45, 46, 47, 48, 49, 50, 51] },
        { id: 'compareCohortRow6', cohorts: [52, 53, 54, 55, 56, 57, 58, 59, 60, 61] },
        { id: 'compareCohortRow7', cohorts: [62, 63, 64, 65, 66] }
      ];
      
      rows.forEach(row => {
        const container = document.getElementById(row.id);
        if (!container) return;
        
        container.innerHTML = '';
        
        row.cohorts.forEach(i => {
          const button = document.createElement('div');
          button.className = 'cohort-button';
          button.setAttribute('data-cohort', i);
          button.setAttribute('data-view', 'compare');
          button.onclick = () => selectCompareCohortFromGrid(i);
          
          button.innerHTML = `
            <div class="cohort-number">Cohort ${i}</div>
            <div class="cohort-date">${cohortDates[i] || 'TBD'}</div>
          `;
          
          container.appendChild(button);
        });
      });
    }

    // ============================================
    // AGGRESSIVE CHART CLEANUP
    // ============================================
    function aggressiveChartCleanup() {
      console.log('üßπ AGGRESSIVE chart cleanup...');
      
      // Method 1: Plotly purge
      try {
        Plotly.purge('chart');
      } catch (e) {}
      try {
        Plotly.purge('chartLarge');
      } catch (e) {}
      try {
        Plotly.purge('chartTotal');
      } catch (e) {}
      
      // Method 2: Direct DOM manipulation
      const chart = document.getElementById('chart');
      const chartLarge = document.getElementById('chartLarge');
      const chartTotal = document.getElementById('chartTotal');
      
      if (chart) {
        // Remove all child elements
        while (chart.firstChild) {
          chart.removeChild(chart.firstChild);
        }
        // Remove Plotly data attribute
        delete chart.data;
        delete chart.layout;
      }
      
      if (chartLarge) {
        while (chartLarge.firstChild) {
          chartLarge.removeChild(chartLarge.firstChild);
        }
        delete chartLarge.data;
        delete chartLarge.layout;
      }
      
      if (chartTotal) {
        while (chartTotal.firstChild) {
          chartTotal.removeChild(chartTotal.firstChild);
        }
        delete chartTotal.data;
        delete chartTotal.layout;
      }
      
      console.log('‚úÖ Aggressive cleanup complete');
    }

    // ============================================
    // COMPLETE COHORT CLEANUP FUNCTION
    // ============================================
    function completeCohortCleanup() {
      console.log('üßπ Performing complete cohort cleanup...');
      
      // Clear all data
      currentData = { single: null, large: null, total: null };
      
      // Clear series completely
      allSeries = [];
      selectedSeries.clear();
      hiddenSeries.clear();
      
      // AGGRESSIVE chart cleanup
      aggressiveChartCleanup();
      
      // Reset series list UI
      document.getElementById('seriesList').innerHTML = '<p style="color: #718096; text-align: center; margin: 2rem 0; font-weight: 500;">Load a dataset to see available data series</p>';
      document.getElementById('seriesCount').textContent = '(0 available)';
      document.getElementById('seriesSearch').value = '';
      
      // Reset load button state
      resetLoadButton();
      
      console.log('‚úÖ Complete cohort cleanup done');
    }

    // ============================================
    // COHORT SELECTION FUNCTIONS
    // ============================================
    function selectSingleType(type) {
      const previousType = selectedSingleType;
      const previousCohort = selectedCohorts.single ? selectedCohorts.single.split('_')[1] : null;
      
      console.log('üîÑ Switching dataset type to:', type, '(previous:', previousType, 'cohort:', previousCohort, ')');
      
      // Clear previous visualization if changing type
      if (selectedSingleType && selectedSingleType !== type) {
        console.log('‚ö†Ô∏è Type changed - performing cleanup');
        completeCohortCleanup();
      }
      
      selectedSingleType = type;
      
      // Update button states
      document.getElementById('singleLargeBtn').classList.remove('active');
      document.getElementById('singleSmallBtn').classList.remove('active');
      
      if (type === 'large') {
        document.getElementById('singleLargeBtn').classList.add('active');
      } else {
        document.getElementById('singleSmallBtn').classList.add('active');
      }
      
      // Show cohort grid
      document.getElementById('singleCohortGridContainer').style.display = 'block';
      
      // Clear previous cohort selection visually
      document.querySelectorAll('[data-view="single"]').forEach(btn => {
        btn.classList.remove('selected');
      });
      
      // Hide controls until cohort is selected
      document.getElementById('mainControls').classList.remove('show');
      
      console.log('‚úÖ Type selection complete');
    }

    function selectSingleCohortFromGrid(cohortNum) {
      if (!selectedSingleType) {
        alert('Please select a dataset type first (Large or Total Particles)');
        return;
      }
      
      console.log('üéØ Single cohort selected:', cohortNum);
      
      // CRITICAL: Check if we're switching cohorts
      const previousCohort = selectedCohorts.single;
      const newCohort = `${selectedSingleType}_${cohortNum}`;
      const isSwitchingCohort = previousCohort && previousCohort !== newCohort;
      
      if (isSwitchingCohort) {
        console.log('üîÑ SWITCHING from', previousCohort, 'to', newCohort);
        completeCohortCleanup();
      } else {
        console.log('‚ú® New cohort selection (not switching)');
      }
      
      // Remove previous selection in single view
      document.querySelectorAll('[data-view="single"]').forEach(btn => {
        btn.classList.remove('selected');
      });
      
      // Add selection to clicked button
      const button = document.querySelector(`[data-view="single"][data-cohort="${cohortNum}"]`);
      if (button) {
        button.classList.add('selected');
        console.log('‚úÖ Button marked as selected');
      }
      
      // Set the cohort value
      selectedCohorts.single = newCohort;
      console.log('‚úÖ selectedCohorts.single set to:', newCohort);
      
      // Show controls
      document.getElementById('mainControls').classList.add('show');
      const typeLabel = selectedSingleType === 'large' ? 'LARGE' : 'TOTAL';
      document.getElementById('selectedCohortTitle').textContent = `Single View: ${typeLabel} ${cohortNum}`;
      document.getElementById('selectedCohortDesc').textContent = 'Click "Load Dataset" button to visualize this cohort';
      
      console.log('‚úÖ Single cohort selection complete. Ready to load.');
    }

    function selectCompareCohortFromGrid(cohortNum) {
      console.log('üéØ Compare cohort selected:', cohortNum);
      
      // CRITICAL: Check if we're switching cohorts
      const previousLarge = selectedCohorts.large;
      const newLarge = `large_${cohortNum}`;
      const newTotal = `small_${cohortNum}`;
      const isSwitchingCohort = previousLarge && previousLarge !== newLarge;
      
      if (isSwitchingCohort) {
        console.log('üîÑ SWITCHING cohorts in compare view');
        completeCohortCleanup();
      } else {
        console.log('‚ú® New cohort selection (not switching)');
      }
      
      // Remove previous selection in compare view
      document.querySelectorAll('[data-view="compare"]').forEach(btn => {
        btn.classList.remove('selected');
      });
      
      // Add selection to clicked button
      const button = document.querySelector(`[data-view="compare"][data-cohort="${cohortNum}"]`);
      if (button) {
        button.classList.add('selected');
        console.log('‚úÖ Button marked as selected');
      }
      
      // Set the cohort values
      selectedCohorts.large = newLarge;
      selectedCohorts.total = newTotal;
      console.log('‚úÖ selectedCohorts set to:', selectedCohorts);
      
      // Show controls
      document.getElementById('mainControls').classList.add('show');
      document.getElementById('selectedCohortTitle').textContent = `Compare View: Cohort ${cohortNum} - Large vs Total`;
      document.getElementById('selectedCohortDesc').textContent = 'Click "Load Dataset" button to visualize both datasets';
      
      console.log('‚úÖ Compare cohort selection complete. Ready to load.');
    }

    // ============================================
    // VIEW SWITCHING
    // ============================================
    function switchView(view) {
      currentView = view;
      
      document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
      
      document.getElementById('single-view').style.display = view === 'single' ? 'block' : 'none';
      document.getElementById('compare-view').style.display = view === 'compare' ? 'block' : 'none';
      
      if (view === 'single') {
        document.getElementById('chart').style.display = 'block';
        document.getElementById('compareCharts').style.display = 'none';
      } else {
        document.getElementById('chart').style.display = 'none';
        document.getElementById('compareCharts').style.display = 'block';
      }
      
      document.getElementById('mainControls').classList.remove('show');
      resetSelections();
    }

    function resetSelections() {
      selectedCohorts = { single: null, large: null, total: null };
      completeCohortCleanup();
      
      // Reset Single view
      selectedSingleType = null;
      document.getElementById('singleLargeBtn').classList.remove('active');
      document.getElementById('singleSmallBtn').classList.remove('active');
      document.getElementById('singleCohortGridContainer').style.display = 'none';
      
      // Clear all selections
      document.querySelectorAll('.cohort-button').forEach(btn => {
        btn.classList.remove('selected');
      });
    }

    // ============================================
    // RESET AND REFRESH FUNCTION
    // ============================================
    function resetAndRefresh() {
      console.log('üîÑ Full reset initiated...');
      
      selectedCohorts = { single: null, large: null, total: null };
      selectedSingleType = null;
      currentScale = 'linear';
      pennsylvaniaData = {};
      
      // Complete cleanup
      completeCohortCleanup();
      
      // Reset UI elements
      document.getElementById('singleLargeBtn').classList.remove('active');
      document.getElementById('singleSmallBtn').classList.remove('active');
      document.getElementById('singleCohortGridContainer').style.display = 'none';
      
      // Clear all cohort selections
      document.querySelectorAll('.cohort-button').forEach(btn => btn.classList.remove('selected'));
      
      // Reset filters
      const singlePaFilter = document.getElementById('singlePaFilter');
      const comparePaFilter = document.getElementById('comparePaFilter');
      if (singlePaFilter) singlePaFilter.checked = false;
      if (comparePaFilter) comparePaFilter.checked = false;
      
      // Hide controls
      document.getElementById('mainControls').classList.remove('show');
      document.getElementById('selectedCohortTitle').textContent = 'No cohort selected';
      document.getElementById('selectedCohortDesc').textContent = 'Select datasets above to begin visualization';
      
      // Reset scale buttons
      document.querySelectorAll('.scale-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.textContent === 'Linear') btn.classList.add('active');
      });
      
      // Reset sampling
      const samplingRadio = document.querySelector('input[name="sampling"][value="1"]');
      if (samplingRadio) samplingRadio.checked = true;
      
      // Reset colorblind mode
      if (isColorblindMode) {
        isColorblindMode = false;
        const accessibilityBtn = document.querySelector('.accessibility-btn');
        if (accessibilityBtn) {
          accessibilityBtn.textContent = 'Enable Colorblind Mode';
          accessibilityBtn.classList.remove('active');
        }
      }
      
      console.log('‚úÖ Full reset complete');
    }

    // ============================================
    // DATA LOADING FUNCTIONS
    // ============================================
    async function loadData() {
      const loadBtn = document.getElementById('loadBtn');
      loadBtn.disabled = true;
      loadBtn.textContent = 'Loading...';

      try {
        console.log('üöÄ ========== LOAD DATA START ==========');
        console.log('   Current view:', currentView);
        console.log('   Selected cohorts:', selectedCohorts);
        
        // CRITICAL: Complete cleanup before loading
        console.log('üßπ Pre-load cleanup...');
        aggressiveChartCleanup();
        currentData = { single: null, large: null, total: null };
        allSeries = [];
        selectedSeries.clear();
        hiddenSeries.clear();
        
        if (currentView === 'single') {
          if (!selectedCohorts.single) {
            throw new Error('No cohort selected');
          }
          console.log('üìä Loading SINGLE cohort:', selectedCohorts.single);
          await loadCohortData('single', selectedCohorts.single);
          console.log('‚úÖ Single cohort data loaded');
          
        } else if (currentView === 'compare') {
          if (!selectedCohorts.large || !selectedCohorts.total) {
            throw new Error('No cohort selected for comparison');
          }
          console.log('üìä Loading COMPARE cohorts:', selectedCohorts.large, selectedCohorts.total);
          await Promise.all([
            loadCohortData('large', selectedCohorts.large),
            loadCohortData('total', selectedCohorts.total)
          ]);
          console.log('‚úÖ Compare cohort data loaded');
        }
        
        console.log('‚úÖ Data loaded, setting up series...');
        console.log('   Data keys:', Object.keys(currentData).filter(k => currentData[k] !== null));
        console.log('   All series count:', allSeries.length);
        
        setupSeriesSelection();
        
        console.log('‚úÖ ========== LOAD DATA COMPLETE ==========');
        resetLoadButton();
        
      } catch (error) {
        console.error('‚ùå ========== LOAD DATA ERROR ==========');
        console.error('   Error:', error);
        alert(`Error: ${error.message}`);
        resetLoadButton();
      }
    }

    async function loadCohortData(key, cohortId) {
      console.log(`   üìÇ Loading cohort data for key="${key}", cohortId="${cohortId}"`);
      const csvPath = `Data/${cohortId}.csv`;
      const response = await fetch(csvPath);
      if (!response.ok) throw new Error(`File not found: ${csvPath}`);

      const csvText = await response.text();
      
      return new Promise((resolve, reject) => {
        Papa.parse(csvText, {
          header: true,
          skipEmptyLines: true,
          complete: function(results) {
            let data = results.data.filter(row => 
              Object.values(row).some(val => val !== null && val !== '')
            );
            
            console.log(`   ‚úÖ Parsed ${data.length} rows`);
            
            const detectedParticipants = detectPAParticipants(data, cohortId);
            updatePAData(cohortId, detectedParticipants);
            
            const paFilterId = currentView === 'single' ? 'singlePaFilter' : 'comparePaFilter';
            if (document.getElementById(paFilterId)?.checked) {
              data = filterPennsylvania(data, cohortId);
              console.log(`   üîç Filtered to ${data.length} PA rows`);
            }
            
            if (data.length === 0) throw new Error('No valid data found');
            
            currentData[key] = data;
            const columns = Object.keys(data[0]);
            const newSeries = columns.slice(1);
            
            allSeries = [...new Set([...allSeries, ...newSeries])];
            
            console.log(`   ‚úÖ Cohort data loaded for "${key}"`);
            resolve();
          },
          error: reject
        });
      });
    }

    function resetLoadButton() {
      const loadBtn = document.getElementById('loadBtn');
      loadBtn.disabled = false;
      loadBtn.textContent = 'Load Dataset';
    }

    // ============================================
    // PENNSYLVANIA FILTERING
    // ============================================
    function detectPAParticipants(csvData, cohortId) {
      if (!csvData || csvData.length === 0) return [];
      
      const columns = Object.keys(csvData[0]);
      const dataColumns = columns.slice(1);
      
      const allParticipants = dataColumns
        .map(col => {
          const match = col.match(/_O_([^_]+)/);
          return match ? match[1] : null;
        })
        .filter(code => code !== null);
      
      const paParticipants = allParticipants.filter(participant => {
        const isNonPA = NON_PA_PATTERNS.some(pattern => 
          participant.includes(pattern.replace('_', ''))
        );
        return !isNonPA;
      });
      
      return [...new Set(paParticipants)];
    }
    
    function updatePAData(cohortId, participants) {
      const parts = cohortId.split('_');
      const cohortNum = parts[1];
      const cohortKey = `cohort_${cohortNum}`;
      
      if (!pennsylvaniaData[cohortKey]) {
        pennsylvaniaData[cohortKey] = {};
      }
      
      pennsylvaniaData[cohortKey][cohortId] = participants;
    }

    function filterPennsylvania(data, cohortId) {
      const parts = cohortId.split('_');
      const cohortNum = parts[1];
      const cohortKey = `cohort_${cohortNum}`;
      
      const paLocations = pennsylvaniaData[cohortKey] && pennsylvaniaData[cohortKey][cohortId];
      
      if (!paLocations || paLocations.length === 0) {
        console.warn(`No PA locations found for ${cohortId}`);
        return data;
      }
      
      return data.filter(row => {
        const columns = Object.keys(row);
        return columns.some(col => 
          paLocations.some(location => 
            col.toUpperCase().includes(location.toUpperCase())
          )
        );
      });
    }

    // ============================================
    // SERIES SELECTION
    // ============================================
    function setupSeriesSelection() {
      console.log('üîß ========== SETUP SERIES START ==========');
      const seriesCount = document.getElementById('seriesCount');
      const seriesList = document.getElementById('seriesList');
      
      console.log('   Total series available:', allSeries.length);
      seriesCount.textContent = `(${allSeries.length} available)`;
      seriesList.innerHTML = '';
      
      const colors = getCurrentColors();
      
      allSeries.forEach((series, index) => {
        const item = document.createElement('div');
        item.className = 'series-item';
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = selectedSeries.has(series) || (selectedSeries.size === 0 && index < 10);
        checkbox.value = series;
        checkbox.onchange = (e) => {
          if (e.target.checked) {
            selectedSeries.add(series);
          } else {
            selectedSeries.delete(series);
          }
          updateVisualization();
        };
        
        if (checkbox.checked) {
          selectedSeries.add(series);
        }
        
        const colorDiv = document.createElement('div');
        colorDiv.className = 'color-indicator';
        colorDiv.style.backgroundColor = colors[index % colors.length];
        
        const label = document.createElement('span');
        label.className = 'series-label';
        label.textContent = series;
        
        const visibilityBtn = document.createElement('button');
        visibilityBtn.className = 'visibility-btn';
        visibilityBtn.textContent = 'Hide';
        visibilityBtn.onclick = (e) => {
          e.stopPropagation();
          toggleSeriesVisibility(series, visibilityBtn);
        };
        
        item.appendChild(checkbox);
        item.appendChild(colorDiv);
        item.appendChild(label);
        item.appendChild(visibilityBtn);
        seriesList.appendChild(item);
      });
      
      console.log('   Selected series:', selectedSeries.size);
      console.log('üìä Calling updateVisualization...');
      console.log('========== SETUP SERIES COMPLETE ==========');
      
      // Small delay to ensure DOM is ready
      setTimeout(() => {
        updateVisualization();
      }, 100);
    }

    function toggleSeriesVisibility(series, button) {
      if (hiddenSeries.has(series)) {
        hiddenSeries.delete(series);
        button.textContent = 'Hide';
        button.classList.remove('hidden');
      } else {
        hiddenSeries.add(series);
        button.textContent = 'Show';
        button.classList.add('hidden');
      }
      updateVisualization();
    }

    function filterSeries() {
      const search = document.getElementById('seriesSearch').value.toLowerCase();
      const items = document.querySelectorAll('.series-item');
      
      items.forEach(item => {
        const label = item.querySelector('.series-label').textContent.toLowerCase();
        item.style.display = label.includes(search) ? 'flex' : 'none';
      });
    }

    function selectAllSeries() {
      document.querySelectorAll('#seriesList input[type="checkbox"]').forEach(cb => {
        cb.checked = true;
        selectedSeries.add(cb.value);
      });
      updateVisualization();
    }

    function clearAllSeries() {
      document.querySelectorAll('#seriesList input[type="checkbox"]').forEach(cb => {
        cb.checked = false;
        selectedSeries.delete(cb.value);
      });
      selectedSeries.clear();
      updateVisualization();
    }

    function getSelectedSeries() {
      const checkboxes = document.querySelectorAll('#seriesList input[type="checkbox"]:checked');
      return Array.from(checkboxes)
        .map(cb => cb.value)
        .filter(series => !hiddenSeries.has(series));
    }

    // ============================================
    // VISUALIZATION
    // ============================================
    function updateVisualization() {
      console.log('üìà ========== UPDATE VISUALIZATION START ==========');
      console.log('   Current view:', currentView);
      console.log('   Current data keys:', Object.keys(currentData).filter(k => currentData[k] !== null));
      
      const selectedSeriesArray = getSelectedSeries();
      console.log('   Selected series count:', selectedSeriesArray.length);
      
      if (selectedSeriesArray.length === 0) {
        console.warn('‚ö†Ô∏è No series selected');
        if (currentView === 'single') {
          document.getElementById('chart').innerHTML = '<div style="padding: 3rem; text-align: center; color: #718096; font-size: 1.1rem; font-weight: 500;">Select at least one data series to display the chart</div>';
        }
        return;
      }

      if (currentView === 'single') {
        console.log('üìä Rendering SINGLE view chart');
        document.getElementById('chart').style.display = 'block';
        document.getElementById('compareCharts').style.display = 'none';
        
        const samplingRate = getSamplingRate();
        let traces = [];

        if (currentData.single) {
          traces = generateTraces(currentData.single, selectedSeriesArray, samplingRate, '');
          console.log('   Generated', traces.length, 'traces');
        } else {
          console.error('‚ùå currentData.single is NULL!');
          return;
        }

        if (traces.length === 0) {
          console.error('‚ùå No traces generated!');
          return;
        }

        const layout = createChartLayout(getChartTitle(selectedSeriesArray.length));
        layout.margin = { l: 80, r: 160, t: 70, b: 60 };
        layout.legend = {
          orientation: 'v',
          x: 1.02,
          y: 1,
          xanchor: 'left',
          yanchor: 'top',
          bgcolor: 'rgba(255,255,255,0.9)',
          bordercolor: '#e2e8f0',
          borderwidth: 1,
          font: { size: 11, color: "#2d3748" },
          itemclick: 'toggle',
          itemdoubleclick: 'toggleothers'
        };
        const config = createChartConfig('single');

        console.log('üé® Calling Plotly.newPlot for SINGLE chart...');
        
        Plotly.newPlot('chart', traces, layout, config).then(() => {
          console.log('‚úÖ Single chart rendered successfully');
          const chartDiv = document.getElementById('chart');
          
          chartDiv.on('plotly_hover', function(eventData) {
            const curveNumber = eventData.points[0].curveNumber;
            const widths = traces.map((_, i) => i === curveNumber ? 8 : 1);
            const opacities = traces.map((_, i) => i === curveNumber ? 1 : 0.05);
            
            Plotly.restyle('chart', {
              'line.width': [widths],
              'opacity': [opacities]
            });
          });
          
          chartDiv.on('plotly_unhover', function() {
            const widths = traces.map(() => 2.5);
            const opacities = traces.map(() => 1);
            
            Plotly.restyle('chart', {
              'line.width': [widths],
              'opacity': [opacities]
            });
          });
        }).catch(error => {
          console.error('‚ùå Error rendering single chart:', error);
        });
        
      } else if (currentView === 'compare') {
        console.log('üìä Rendering COMPARE view charts');
        document.getElementById('chart').style.display = 'none';
        document.getElementById('compareCharts').style.display = 'block';
        
        const samplingRate = getSamplingRate();
        
        if (currentData.large) {
          console.log('   üìä Rendering LARGE chart...');
          const largeTraces = generateTraces(currentData.large, selectedSeriesArray, samplingRate, '');
          console.log('   Generated', largeTraces.length, 'traces');
          const largeLayout = createChartLayout(`Large Particles - Cohort ${selectedCohorts.large?.split('_')[1] || ''} (${selectedSeriesArray.length} series)`);
          const largeConfig = createChartConfig('large');
          
          Plotly.newPlot('chartLarge', largeTraces, largeLayout, largeConfig).then(() => {
            console.log('   ‚úÖ Large chart rendered');
            const chartLarge = document.getElementById('chartLarge');
            
            chartLarge.on('plotly_hover', function(eventData) {
              const curveNumber = eventData.points[0].curveNumber;
              const widths = largeTraces.map((_, i) => i === curveNumber ? 8 : 1);
              const opacities = largeTraces.map((_, i) => i === curveNumber ? 1 : 0.05);
              
              Plotly.restyle('chartLarge', {
                'line.width': [widths],
                'opacity': [opacities]
              });
            });
            
            chartLarge.on('plotly_unhover', function() {
              Plotly.restyle('chartLarge', {
                'line.width': [largeTraces.map(() => 2.5)],
                'opacity': [largeTraces.map(() => 1)]
              });
            });
          }).catch(error => {
            console.error('‚ùå Error rendering Large chart:', error);
          });
        }
        
        if (currentData.total) {
          console.log('   üìä Rendering TOTAL chart...');
          const totalTraces = generateTraces(currentData.total, selectedSeriesArray, samplingRate, '');
          console.log('   Generated', totalTraces.length, 'traces');
          const totalLayout = createChartLayout(`Total Particles - Cohort ${selectedCohorts.total?.split('_')[1] || ''} (${selectedSeriesArray.length} series)`);
          const totalConfig = createChartConfig('total');
          
          Plotly.newPlot('chartTotal', totalTraces, totalLayout, totalConfig).then(() => {
            console.log('   ‚úÖ Total chart rendered');
            const chartTotal = document.getElementById('chartTotal');
            
            chartTotal.on('plotly_hover', function(eventData) {
              const curveNumber = eventData.points[0].curveNumber;
              const widths = totalTraces.map((_, i) => i === curveNumber ? 8 : 1);
              const opacities = totalTraces.map((_, i) => i === curveNumber ? 1 : 0.05);
              
              Plotly.restyle('chartTotal', {
                'line.width': [widths],
                'opacity': [opacities]
              });
            });
            
            chartTotal.on('plotly_unhover', function() {
              Plotly.restyle('chartTotal', {
                'line.width': [totalTraces.map(() => 2.5)],
                'opacity': [totalTraces.map(() => 1)]
              });
            });
          }).catch(error => {
            console.error('‚ùå Error rendering Total chart:', error);
          });
        }
      }
      
      console.log('‚úÖ ========== UPDATE VISUALIZATION COMPLETE ==========');
    }

    function createChartLayout(title) {
      return {
        title: {
          text: title,
          font: { size: 26, family: "Times New Roman, Times, serif", color: "#1a365d" },
          x: 0.5,
          xanchor: 'center'
        },
        xaxis: { 
          title: {
            text: 'Date and Time',
            font: { size: 18, color: "#2d3748", family: "Times New Roman, Times, serif" }
          },
          showgrid: true,
          gridcolor: '#cccccc',
          gridwidth: 2,
          dtick: 86400000,
          tick0: '2020-01-01',
          linecolor: '#2c5aa0',
          linewidth: 2,
          tickfont: { size: 15, color: "#4a5568", family: "Times New Roman, Times, serif" },
          showspikes: true,
          spikemode: 'across',
          spikesnap: 'cursor',
          spikecolor: '#1a365d',
          spikethickness: 2,
          spikedash: 'solid'
        },
        yaxis: { 
          title: {
            text: 'Particle Count (per 0.01 ft¬≥)',
            font: { size: 18, color: "#2d3748", family: "Times New Roman, Times, serif" }
          },
          type: currentScale,
          showgrid: true,
          gridcolor: '#f0f8ff',
          gridwidth: 1,
          linecolor: '#2c5aa0',
          linewidth: 2,
          tickfont: { size: 15, color: "#4a5568", family: "Times New Roman, Times, serif" }
        },
        margin: { l: 90, r: 50, t: 80, b: 70 },
        legend: {
          orientation: 'h',
          x: 0.5,
          y: -0.15,
          xanchor: 'center',
          yanchor: 'top',
          bgcolor: 'rgba(240, 248, 255, 0.95)',
          bordercolor: '#2c5aa0',
          borderwidth: 1,
          font: { size: 14, color: "#2d3748", family: "Times New Roman, Times, serif" },
          itemclick: 'toggle',
          itemdoubleclick: 'toggleothers'
        },
        hovermode: 'closest',
        hoverdistance: 50,
        plot_bgcolor: 'white',
        paper_bgcolor: 'white',
        font: { family: "Times New Roman, Times, serif", color: "#2d3748" }
      };
    }

    function createChartConfig(chartType) {
      return {
        responsive: true,
        displaylogo: false,
        scrollZoom: true,
        doubleClick: 'reset',
        displayModeBar: true,
        modeBarButtonsToRemove: [
          'select2d',
          'lasso2d',
          'autoScale2d',
          'hoverClosestCartesian',
          'hoverCompareCartesian',
          'toggleSpikelines'
        ],
        modeBarButtonsToAdd: [],
        toImageButtonOptions: {
          format: 'png',
          filename: `rocis_${chartType}_${Date.now()}`,
          height: 600,
          width: 700,
          scale: 2
        }
      };
    }

    function generateTraces(data, selectedSeries, samplingRate, prefix) {
      const columns = Object.keys(data[0]);
      const timeColumn = columns[0];
      const colors = getCurrentColors();
      
      const sampledData = samplingRate > 1 ? 
        data.filter((_, index) => index % samplingRate === 0) : 
        data;

      return selectedSeries
        .filter(series => columns.includes(series))
        .map((series, index) => {
          const seriesIndex = allSeries.indexOf(series);
          return {
            type: 'scatter',
            mode: 'lines',
            name: prefix + series,
            x: sampledData.map(row => row[timeColumn]),
            y: sampledData.map(row => {
              const val = parseFloat(row[series]);
              return isNaN(val) ? null : val;
            }),
            line: { 
              width: 2.5,
              color: colors[seriesIndex % colors.length]
            },
            hovertemplate: `<b>${prefix}${series}</b><br>%{x}<br>%{y:.2f} particles<extra></extra>`,
            connectgaps: false
          };
        });
    }

    function getChartTitle(seriesCount) {
      if (currentView === 'single') {
        return `${selectedCohorts.single?.replace('_', ' ').toUpperCase() || 'Single View'} - Outdoor Data Explorer (${seriesCount} series)`;
      } else {
        let title = 'Compare View - ';
        if (selectedCohorts.large && selectedCohorts.total) {
          title += `${selectedCohorts.large.toUpperCase()} vs ${selectedCohorts.total.toUpperCase()}`;
        } else if (selectedCohorts.large) {
          title += `${selectedCohorts.large.toUpperCase()} (Large)`;
        } else if (selectedCohorts.total) {
          title += `${selectedCohorts.total.toUpperCase()} (Total)`;
        }
        return `${title} (${seriesCount} series)`;
      }
    }

    // ============================================
    // UTILITY FUNCTIONS
    // ============================================
    function getCurrentColors() {
      return isColorblindMode ? colorblindColors : defaultColors;
    }

    function getSamplingRate() {
      const selected = document.querySelector('input[name="sampling"]:checked');
      return selected ? parseInt(selected.value) : 1;
    }

    function setScale(scale) {
      currentScale = scale;
      
      document.querySelectorAll('.scale-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
      
      if (Object.values(currentData).some(data => data)) {
        updateVisualization();
      }
    }

    function toggleColorblind() {
      const button = document.querySelector('.accessibility-btn');
      
      isColorblindMode = !isColorblindMode;
      
      if (isColorblindMode) {
        button.textContent = 'Disable Colorblind Mode';
        button.classList.add('active');
      } else {
        button.textContent = 'Enable Colorblind Mode';
        button.classList.remove('active');
      }
      
      const colorIndicators = document.querySelectorAll('.color-indicator');
      const colors = getCurrentColors();
      colorIndicators.forEach((indicator, index) => {
        indicator.style.backgroundColor = colors[index % colors.length];
      });
      
      if (Object.values(currentData).some(data => data)) {
        updateVisualization();
      }
    }

    function downloadData() {
      if (currentView === 'single' && selectedCohorts.single) {
        downloadCsv(selectedCohorts.single);
      } else if (currentView === 'compare') {
        if (selectedCohorts.large) downloadCsv(selectedCohorts.large);
        if (selectedCohorts.total) downloadCsv(selectedCohorts.total);
      } else {
        alert('Please select a cohort first!');
      }
    }

    function downloadCsv(cohortId) {
      const link = document.createElement('a');
      link.href = `Data/${cohortId}.csv`;
      link.download = `${cohortId}.csv`;
      link.click();
    }

    function showScaleHelp() {
      const message = `Scale Type Options:

- Linear Scale: Standard scale where equal distances represent equal value differences. Best for seeing absolute changes in particle counts.

- Log Scale: Logarithmic scale where each step represents a multiplication. Useful when data spans multiple orders of magnitude, making it easier to see patterns in both low and high values simultaneously.

Tip: Use Linear for general viewing, switch to Log if you have very large value ranges.`;
      
      alert(message);
    }

    function showSamplingHelp() {
      const message = `Data Sampling Options:

- All points: Display every data point from the CSV file. Provides complete detail but may slow down rendering for large datasets.

- Every 5th: Display every 5th data point. Reduces data by 80%, improving performance while maintaining overall patterns.

- Every 10th: Display every 10th data point. Reduces data by 90%, maximizing performance for very large datasets.

Tip: Start with "All points" for detailed analysis. Switch to sampling if the chart feels slow or cluttered.`;
      
      alert(message);
    }

    // ============================================
    // INITIALIZATION
    // ============================================
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üöÄ Page loaded - initializing...');
      
      // Generate both cohort grids on page load
      generateSingleCohortGrid();
      generateCompareCohortGrid();
      
      // Pennsylvania filter listeners
      ['singlePaFilter', 'comparePaFilter'].forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          element.addEventListener('change', () => {
            if (Object.values(currentData).some(data => data)) {
              loadData();
            }
          });
        }
      });
      
      console.log('‚úÖ Initialization complete');
    });
  </script>
</body>
</html>
