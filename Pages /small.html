<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ROCIS - Outdoor Particle Count (Large)</title>

  <!-- Libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:'Inter',sans-serif; background:#fff; color:#111827; line-height:1.6; }
    .container { max-width:1100px; margin:20px auto; padding:20px; }

    .header { text-align:center; padding:30px 20px; border-bottom:1px solid #e5e7eb; margin-bottom:20px; }
    .main-title { font-size:2.2em; font-weight:700; }
    .subtitle   { font-size:1em; color:#4b5563; }

    .nav-menu { background:#f9fafb; border-bottom:1px solid #e5e7eb; margin-bottom:30px; }
    .nav-menu ul { list-style:none; display:flex; justify-content:center; flex-wrap:wrap; }
    .nav-menu a { padding:15px 20px; text-decoration:none; color:#374151; font-weight:600; font-size:.9em; }
    .nav-menu a:hover { background:#f3f4f6; }
    .nav-menu a.active { border-bottom:3px solid #2563eb; color:#2563eb; }

    .page-title { font-size:1.8em; font-weight:700; text-align:center; margin-bottom:20px; }
    .card { background:#fff; border:1px solid #e5e7eb; border-radius:8px; padding:20px; margin:20px 0;
            box-shadow:0 2px 6px rgba(0,0,0,.05); }
    .chart-title { font-size:1.2em; font-weight:600; margin-bottom:12px; text-align:center; }
    .chart-wrapper { position:relative; height:420px; }

    .cohort-buttons { display:flex; flex-wrap:wrap; gap:8px; justify-content:center; margin:20px 0; }
    .cohort-btn { padding:6px 14px; border:2px solid #2563eb; border-radius:20px; background:#fff; color:#2563eb;
                  font-weight:600; cursor:pointer; font-size:.85em; }
    .cohort-btn:hover, .cohort-btn.active { background:#2563eb; color:#fff; }

    .controls { display:flex; justify-content:center; gap:12px; flex-wrap:wrap; margin:16px 0; }
    .btn { padding:8px 16px; border:none; border-radius:6px; background:#2563eb; color:#fff; font-weight:600; cursor:pointer; }
    .btn.secondary { background:#6b7280; }

    .data-info { background:#f9fafb; padding:15px; border-radius:6px; border-left:4px solid #2563eb; margin:20px 0; }

    @media (max-width:768px){ .chart-wrapper{height:320px;} }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <h1 class="main-title">ROCIS Low Cost Monitoring Project</h1>
      <p class="subtitle">Data Visualization and Knowledge Base</p>
    </div>

    <!-- Nav -->
    <nav class="nav-menu">
      <ul>
        <li><a href="index.html">HOME</a></li>
        <li><a href="dygraphs-large.html" class="active">DYGRAPHS LARGE</a></li>
        <li><a href="dygraphs-small.html">DYGRAPHS SMALL</a></li>
        <li><a href="data-upload.html">UPLOAD</a></li>
      </ul>
    </nav>

    <h1 class="page-title">Outdoor Particle Count Data (Large)</h1>

    <div class="data-info">
      <p><strong>Tip:</strong> CSVs are loaded from <code>/data/large_XX.csv</code>. Click a cohort to load its CSV. Visitors can download the same file via the button.</p>
    </div>

    <!-- Cohort buttons -->
    <div class="cohort-buttons" id="cohortButtons"></div>

    <!-- Main chart card -->
    <div class="card">
      <h3 class="chart-title" id="chartTitle">Particle Count Over Time - Cohort 01</h3>
      <div class="chart-wrapper"><canvas id="particleChart"></canvas></div>
      <div class="controls">
        <button class="btn" id="toggleScaleBtn">Toggle Linear/Log</button>
        <a class="btn secondary" id="downloadBtn" href="#" download>Download CSV</a>
      </div>
      <div id="status"></div>
    </div>

    <!-- Secondary chart (daily averages for the loaded file) -->
    <div class="card">
      <h3 class="chart-title">Daily Averages (per series)</h3>
      <div class="chart-wrapper"><canvas id="dailyChart"></canvas></div>
    </div>
  </div>

  <script>
    // ====== CONFIG ======
    const COHORTS = ["01","02","03","04","05","06","07","08","09","10"]; // extend as needed
    const FILE_PATTERN = n => `data/large_${n}.csv`;

    // ====== STATE ======
    let particleChart, dailyChart;
    let currentCohort = "01";
    let isLogScale = false;

    // ====== UI BUILD ======
    buildCohortButtons();
    document.getElementById('toggleScaleBtn').addEventListener('click', toggleScale);

    // Init charts empty
    const ctx1 = document.getElementById('particleChart').getContext('2d');
    particleChart = new Chart(ctx1, {
      type: 'line',
      data: { labels: [], datasets: [
        { label:'Small Particles', data:[], borderColor:'#2563eb', backgroundColor:'#2563eb33', tension:0.35, fill:true },
        { label:'Large Particles', data:[], borderColor:'#1d4ed8', backgroundColor:'#1d4ed833', tension:0.35, fill:true }
      ]},
      options: {
        responsive:true, maintainAspectRatio:false,
        interaction:{intersect:false,mode:'index'},
        scales:{ y:{ beginAtZero:true, type:'linear', title:{display:true,text:'Particle Count'} },
                x:{ title:{display:true,text:'Time'} } }
      }
    });

    const ctx2 = document.getElementById('dailyChart').getContext('2d');
    dailyChart = new Chart(ctx2, {
      type:'bar',
      data:{ labels:[], datasets:[{ label:'Average', data:[], backgroundColor:'#2563eb' }]},
      options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ display:false } } }
    });

    // Load first cohort on start
    loadCohort(currentCohort);

    // ====== BUTTONS ======
    function buildCohortButtons(){
      const wrap = document.getElementById('cohortButtons');
      COHORTS.forEach(n => {
        const b = document.createElement('button');
        b.className = 'cohort-btn' + (n===currentCohort ? ' active' : '');
        b.textContent = `Cohort ${n}`;
        b.addEventListener('click', () => {
          document.querySelectorAll('.cohort-btn').forEach(x=>x.classList.remove('active'));
          b.classList.add('active');
          loadCohort(n);
        });
        wrap.appendChild(b);
      });
    }

    // ====== LOADING CSV ======
    function loadCohort(num){
      currentCohort = num;
      const path = FILE_PATTERN(num);
      document.getElementById('chartTitle').textContent = `Particle Count Over Time - Cohort ${num}`;
      document.getElementById('downloadBtn').href = path;
      showStatus(`Loading ${path} â€¦`, 'info');

      Papa.parse(path, {
        download: true,
        header: true,
        dynamicTyping: true,
        skipEmptyLines: true,
        complete: (res) => {
          if (res.errors?.length) {
            showStatus(`Error parsing CSV: ${res.errors[0].message}`, 'error');
            return;
          }
          const rows = res.data;
          if (!rows.length) { showStatus('CSV is empty.', 'error'); return; }

          const { timeCol, smallCol, largeCol } = guessColumns(res.meta.fields);
          if (!timeCol || !smallCol || !largeCol) {
            showStatus('Could not auto-detect columns. Expected Date/Time + Small + Large.', 'error');
            console.log('Detected fields:', res.meta.fields);
            return;
          }

          // Build labels + series
          const labels = rows.map(r => {
            const d = new Date(r[timeCol]);
            return isNaN(d) ? String(r[timeCol]) : d.toLocaleString();
          });
          const small = rows.map(r => numOrNull(r[smallCol]));
          const large = rows.map(r => numOrNull(r[largeCol]));

          // Update line chart
          particleChart.data.labels = labels;
          particleChart.data.datasets[0].data = small;
          particleChart.data.datasets[1].data = large;
          particleChart.update();

          // Daily averages (simple mean over entire file per series)
          const avgSmall = mean(small);
          const avgLarge = mean(large);
          dailyChart.data.labels = ['Small', 'Large'];
          dailyChart.data.datasets[0].data = [avgSmall, avgLarge];
          dailyChart.update();

          showStatus(`Loaded ${rows.length} rows from ${path}`, 'success');
        },
        error: (err) => showStatus(`Load error: ${err?.message || err}`, 'error')
      });
    }

    function guessColumns(fields){
      // Case-insensitive matching
      const lower = fields.map(f => f.toLowerCase());
      const find = (...cands) => {
        for (const c of cands) {
          const i = lower.indexOf(c.toLowerCase());
          if (i !== -1) return fields[i];
        }
        return null;
      };
      // time/date candidates
      const timeCol  = find('date', 'time', 'timestamp', 'datetime', 'raw start time', 'raw_end_time');
      // small/large candidates
      const smallCol = find('small_particles','small','sp','smallcount','small_count');
      const largeCol = find('large_particles','large','lp','largecount','large_count');
      return { timeCol, smallCol, largeCol };
    }

    function numOrNull(v){
      const n = typeof v === 'number' ? v : Number(String(v).replace(/,/g,'').trim());
      return isFinite(n) ? n : null;
    }
    function mean(arr){
      const nums = arr.filter(v => typeof v === 'number' && isFinite(v));
      return nums.length ? (nums.reduce((a,b)=>a+b,0) / nums.length) : 0;
    }

    // ====== CONTROLS ======
    function toggleScale(){
      isLogScale = !isLogScale;
      particleChart.options.scales.y.type = isLogScale ? 'logarithmic' : 'linear';
      particleChart.update();
    }

    // ====== STATUS UI ======
    function showStatus(msg, type='info'){
      const el = document.getElementById('status');
      const styles = {
        info:    'background:#f3f4f6;color:#374151',
        success: 'background:#dcfce7;color:#166534',
        error:   'background:#fee2e2;color:#991b1b'
      };
      el.style.cssText = `margin-top:10px;padding:10px;border-radius:6px;${styles[type]||styles.info}`;
      el.textContent = msg;
    }
  </script>
</body>
</html>
